#!/bin/bash

# Installs all apt dependencies that are needed to build D2.

set -e
cd "$(dirname $0)/.."

dependencies=(
  libcairo2-dev
  libsqlite3-dev
  libleptonica-dev
  libtesseract-dev
  libgraphviz-dev
  # TODO: poppler-utils and libssl1.1 needed?
)

# Set up cross-compilation if needed

if [ -n "$BUILDARCH" ] && [ -n "$TARGETARCH" ] && [ "$BUILDARCH" != "$TARGETARCH" ]; then
  echo "==> Installing cross-compilation sysroot for $TARGETARCH"
  apt-get update
  apt-get install -y \
    crossbuild-essential-"$TARGETARCH"

  echo "==> Configuring dpkg to install packages for $TARGETARCH"
  dpkg --add-architecture "$TARGETARCH"

  echo "==> Setting dependencies to use $TARGETARCH"
  for (( i=0; i<${#dependencies[@]}; i++ )); do
    dependencies[$i]="${dependencies[$i]}:$TARGETARCH"
  done
fi

echo "==> Installing ${dependencies[@]}"
apt-get update
apt-get install -y \
  "${dependencies[@]}"
